% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/matching-core.R
\name{treatment_effect_calculation}
\alias{treatment_effect_calculation}
\title{Compute log-linear treatment effects (ATE/ATET/ATEU) for multiple outcomes}
\usage{
treatment_effect_calculation(
  data,
  outcome_variables,
  normalize = NULL,
  i,
  match_specifications,
  matching_output_directory,
  match_formulas
)
}
\arguments{
\item{data}{A \code{data.frame} containing at least:
\itemize{
\item \code{unique_identifier}: unit identifier used for merging matched weights,
\item \code{Treat}: treatment indicator (logical or 0/1),
\item \code{Area}: plot size (positive; used for input checks and typical scaling),
\item all variables named in \code{outcome_variables},
\item any covariates referenced in \code{match_formulas$general_match} and
\code{match_formulas$exact_match}.
}}

\item{outcome_variables}{Character vector of outcome variable names
(e.g., \code{c("HrvstKg","Area","SeedKg","HHLaborAE","HirdHr","FertKg","PestLt")}).}

\item{normalize}{Logical scalar. If \code{TRUE}, each outcome in
\code{outcome_variables} is divided by the first element of \code{outcome_variables}
in the merged data (e.g., to obtain outcomes per hectare or per unit).}

\item{i}{Integer index selecting the row of \code{match_specifications} and the
corresponding matching result file (zero-padded via \code{ARRAY} to
\code{"NNNN.rds"}).}

\item{match_specifications}{A \code{data.frame} with at least a column
\code{ARRAY}. The \code{i}-th row is used to locate the matching output file
and is cbind-ed to the returned results.}

\item{matching_output_directory}{Directory containing per-specification matching
results named \code{"match_0001.rds"}, \code{"match_0002.rds"}, etc. Each RDS
is expected to contain an element \code{$md} with columns
\code{unique_identifier} and \code{weights}.}

\item{match_formulas}{A list with:
\itemize{
\item \code{general_match}: a formula; the RHS is accessed via
\code{as.character(...)[3]},
\item \code{exact_match}: a formula; the RHS is accessed via
\code{as.character(...)[2]}.
}}
}
\value{
A \code{data.frame} (\code{atet_scalar}) with the columns from
\code{match_specifications[i, ]} repeated across rows, and the additional columns:
\itemize{
\item \code{outcome}: outcome variable name,
\item \code{treatment}: name of the treatment indicator (always \code{"Treat"}),
\item \code{level}: one of
\code{"ATE"}, \code{"ATET"}, \code{"ATEU"},
\code{"aic"}, \code{"ll"}, \code{"R2"}, \code{"N"}, \code{"Ft"}, \code{"R2a"},
\item \code{est}: numeric estimate corresponding to \code{level}.
}
One block of rows is returned per outcome in \code{outcome_variables}. If a model
fails for a given outcome, that outcome is skipped.
}
\description{
For a given matching specification index \code{i}, this function:
\enumerate{
\item Loads the corresponding matched weights file from \code{matching_output_directory},
\item Merges those weights into the analysis \code{data} via \code{unique_identifier},
\item Optionally normalizes each outcome by the first element of \code{outcome_variables}
(e.g., to construct per-hectare or per-unit measures),
\item Fits a weighted log-linear model for each outcome with interactions between
\code{Treat} and the supplied matching covariate formulas,
\item Transforms fitted differences into percentage treatment effects, trims extreme
values, and computes weighted ATE, ATET, and ATEU alongside model fit statistics.
}
}
\details{
For each outcome \code{oc} in \code{outcome_variables}, the function:
\enumerate{
\item Filters to observations with non-missing \code{Treat}, the outcome, and
\code{weights},
\item Constructs a log-linear model of the form
\preformatted{
log(oc + eps) ~ Treat * (general_match_rhs + exact_match_rhs)
}
where \code{eps = min(oc[oc > 0]) * 1/100} in the estimation sample,
\item Fits the model using \code{lm()} with weights given by the matched
\code{weights},
\item Predicts fitted log outcomes for treated (\code{Treat = 1}) and untreated
(\code{Treat = 0}) counterfactuals,
\item Computes individual percentage treatment effects
\deqn{TE_OLS = \{ \exp(\hat{y}_1 - \hat{y}_0) - 1 \} \times 100,}
trims them to the interval \eqn{[-100, 100]}, and then forms:
\itemize{
\item ATE: weighted mean of \code{TE_OLS} over all units,
\item ATET: weighted mean of \code{TE_OLS} among treated units,
\item ATEU: weighted mean of \code{TE_OLS} among untreated units.
}
}
In addition, for each outcome the function records model diagnostics:
AIC, log-likelihood, \eqn{R^2}, adjusted \eqn{R^2}, F-statistic, and the sample size
used in the regression.
}
\seealso{
Other matching: 
\code{\link{covariate_balance}()},
\code{\link{draw_matched_samples}()},
\code{\link{match_sample_specifications}()},
\code{\link{treatment_effect_summary}()},
\code{\link{write_match_formulas}()}
}
\concept{matching}
