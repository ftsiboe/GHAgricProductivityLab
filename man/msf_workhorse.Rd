% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/stochastic_frontier-core.R
\name{msf_workhorse}
\alias{msf_workhorse}
\title{Meta stochastic frontier (MSF) workhorse}
\usage{
msf_workhorse(
  data,
  output_variable,
  input_variables,
  inefficiency_covariates = NULL,
  risk_covariates = NULL,
  weight_variable = NULL,
  production_slope_shifters = NULL,
  intercept_shifters = NULL,
  f,
  d,
  identifiers,
  include_trend = FALSE,
  technology_variable = NULL,
  matching_type = NULL,
  adoption_covariates = NULL,
  intercept_shifters_meta = NULL
)
}
\arguments{
\item{data}{A data.frame or data.table containing the estimation sample.
Must include the dependent variable \code{output_variable}, the inputs in \code{input_variables},
the weight variable \code{weight_variable}, unique ID variables in \code{identifiers}, any
inefficiency and risk covariates in \code{inefficiency_covariates} and \code{risk_covariates}, the
technology variable \code{technology_variable} (if used), and any variables required by
matching objects on disk (e.g., \code{"Surveyx"}, \code{"EaId"}, \code{"HhId"},
\code{"Mid"}, \code{"unique_identifier"}).}

\item{output_variable}{Character scalar. Name of the dependent (output) variable used
in the production frontier.}

\item{input_variables}{Character vector of input variable names (e.g., land, labor,
capital) passed through to \code{\link{sf_workhorse}}.}

\item{inefficiency_covariates}{Optional named list specifying variables in the inefficiency
function for the naive and group frontiers. Typical structure:
\code{list(scalar_variables = c(...), factor_variables = c(...))}.}

\item{risk_covariates}{Optional named list specifying variables in the production
risk (noise) function for the naive and group frontiers. Same structure
as \code{inefficiency_covariates}. If \code{NULL}, a homoskedastic noise term is usually
implied.}

\item{weight_variable}{Character scalar. Name of the sampling/observation weight
variable in \code{data}. Observations with zero weight are dropped.}

\item{production_slope_shifters}{Character scalar giving the name of a slope-shifter
variable in \code{data} (e.g., technology shifter, policy dummy). Defaults
to \code{NULL} for no slope shifter.}

\item{intercept_shifters}{Optional named list of intercept shifter variables
for the naive and group frontiers. Typical structure:
\code{list(scalar_variables = c(...), factor_variables = c(...))}, passed to
\code{\link{sf_workhorse}}.}

\item{f}{Functional form index for the production frontier (e.g.,
Cobb-Douglas, translog, quadratic). The index is passed to
\code{\link{sf_workhorse}} and ultimately to the internal form-selection
utilities (e.g., \code{sf_functional_forms}).}

\item{d}{Distributional form index for the inefficiency term (e.g.,
half-normal, truncated-normal). Passed to \code{\link{sf_workhorse}}.}

\item{identifiers}{Character vector of variable names that uniquely identify
observations (e.g., \code{c("unique_identifier","Survey","CropID","HhId","EaId","Mid")}).
These IDs are used when merging scores and summarizing by technology or
sample.}

\item{include_trend}{Logical; if \code{TRUE}, the last element in \code{input_variables} is
treated as a trend/technology variable in the production function.
Passed through to \code{\link{sf_workhorse}}. Defaults to \code{FALSE}.}

\item{technology_variable}{Optional character scalar naming the technology variable (e.g.,
region, system, period) used to define groups for group SF and meta-frontier
estimation. If \code{NULL}, no technology groups are formed and only the
naive frontier and TE are computed.}

\item{matching_type}{Optional character scalar controlling which nearest-neighbor
matching specifications to use for meta-frontier estimation. When not
\code{NULL}, the function reads matching specifications and matched
samples from \code{"results/matching/"} and related RDS files. Setting
\code{matching_type = "optimal"} restricts attention to the subset of matching
specifications labeled as optimal.}

\item{adoption_covariates}{Optional named list specifying inefficiency-function covariates
for the meta-frontier (matched/unmatched) estimation. If \code{NULL},
defaults to \code{inefficiency_covariates}.}

\item{intercept_shifters_meta}{Optional named list of intercept shifters for the
meta-frontier estimation. If \code{NULL}, defaults to
\code{intercept_shifters}.}
}
\value{
A named list with the following components:
\itemize{
\item \code{sf_estm}: Data.frame of coefficient-level summaries from all
naive, group, and meta-frontiers (including LR tests), augmented with
technology identifiers (\code{Tech}) and \code{sample} labels
(e.g., \code{"unmatched"}, matching-spec names).
\item \code{ef_mean}: Data.frame of aggregated efficiency statistics
(TE0, TE, TGR, MTE), including weighted/unweighted means, medians, and
modes, by survey, sample, technology, type, estimation type, and
restriction status. When \code{technology_variable} is supplied, also includes
efficiency gap levels and percentages.
\item \code{ef_dist}: Data.frame of efficiency distributions (histogram
counts and weights) over efficiency ranges, by survey, sample,
technology, type, estimation type, and restriction.
\item \code{rk_dist}: Data.frame of risk distributions (histogram counts
and weights) analogous to \code{ef_dist}, with \code{type = "risk"}.
\item \code{el_mean}: Data.frame of aggregated elasticity statistics
(weighted/unweighted means, medians, modes) by input, survey, sample,
technology, and restriction, including elasticity-gap measures when
\code{technology_variable} is provided.
\item \code{rk_mean}: Data.frame of aggregated risk statistics (weighted
and unweighted) by survey, sample, technology, and restriction, with
risk-gap measures when \code{technology_variable} is provided.
\item \code{el_samp}: Data.frame of observation-level elasticities for
all models and samples (excluding the synthetic \code{"GLSS0"} survey
rows).
\item \code{ef_samp}: Data.frame of observation-level efficiency scores
(TE0, TE, TGR, MTE) including IDs, weights, technologies, and sample
labels.
\item \code{rk_samp}: Data.frame of observation-level risk measures for
all models and samples (excluding the synthetic \code{"GLSS0"} survey
rows).
}
}
\description{
Performs Meta Stochastic Frontier (MSF) analysis in several stages:
\enumerate{
\item \strong{Naive SF:} Fits a pooled stochastic frontier and computes
baseline technical efficiency (TE) measures.
\item \strong{Group SF:} If a technology variable \code{technology_variable} is supplied,
splits the sample into technology groups and fits group-specific SF
models.
\item \strong{Meta SF (unmatched and matched):} Constructs a meta-frontier
using fitted values from group models and, optionally, nearest-neighbor
matching specifications. From this, it derives technology gap ratios
(TGR) and meta-technical efficiency (MTE).
\item \strong{Summaries and distributions:} Produces weighted and
unweighted summaries and distributional statistics for efficiency,
elasticity, and risk across technologies, samples (unmatched/matched),
and surveys.
}
}
\details{
The function is designed as a high-level orchestrator around
\code{\link{sf_workhorse}}, assembling naive, group-level, and meta-frontier
results into a unified output structure suitable for MSF analysis.

The workflow can be summarized as:
\itemize{
\item \strong{Naive SFA (TE0):} Calls \code{\link{sf_workhorse}} on the full
sample to obtain baseline efficiencies (\code{teBC}, \code{teJLMS},
\code{teMO}). If no technology variable is specified (\code{technology_variable = NULL}),
these naive efficiencies are the final scores and only TE-related
summaries are produced.

\item \strong{Group SFA (TE):} When \code{technology_variable} is provided, the sample
is recoded into numeric technology groups (\code{Tech}), and
\code{\link{sf_workhorse}} is applied separately to each group.
Group-level efficiencies are combined into TE measures by group and survey.

\item \strong{Meta-frontier (TGR and MTE):} Using fitted group-frontier
values (\code{Yhat}) from the restricted models, the function fits
meta-frontiers (unmatched and, optionally, matched) again via
\code{\link{sf_workhorse}}. Technology gap ratios (TGR) are derived
from these meta-frontiers, and meta-technical efficiency (MTE) is
computed as \code{TE * TGR}.

\item \strong{Matching layer (optional):} If \code{matching_type} is given, the
function loads matching specifications (\code{mspecs}, \code{mspecs_optimal})
and corresponding matched samples from disk (e.g., \code{"results/matching/"}),
fits additional meta-frontiers by matching specification, and augments
the set of scores and summaries with these matched samples.

\item \strong{Summaries and distributions:}
\describe{
\item{Scores:}{TE0, TE, TGR, and MTE are reshaped into long form and
aggregated to compute weighted/unweighted means, medians, modes, and
distribution histograms (both count-based and weight-based) across
surveys, samples, technologies, and estimation types. When
\code{technology_variable} is not \code{NULL}, the function also computes
technology gaps (level and percent) relative to the minimum
technology in \code{  technology_legend}.}
\item{Elasticities:}{Elasticities from the underlying SF models
(naive, group, meta) are combined and summarized in a similar way,
including technology-gap metrics for elasticities when \code{technology_variable}
is provided.}
\item{Risk:}{Risk measures derived from \code{sf_workhorse} are
combined, summarized, and used to build distributional statistics
analogous to those for efficiency.}
}

\item \strong{LR tests:} When \code{technology_variable} is not \code{NULL}, the function
builds likelihood ratio test statistics comparing a naive pooled
frontier to the combination of group and meta-frontiers, storing these
as rows with \code{CoefName = "LRT"} in the \code{sf_estm} output.
}

Throughout, the function uses \pkg{dplyr}, \pkg{tidyr}, \pkg{data.table},
\pkg{doBy}, and related helper functions for reshaping and summarizing the
output of \code{\link{sf_workhorse}}.
}
\seealso{
Other frontier analysis: 
\code{\link{equation_editor}()},
\code{\link{fit_organizer}()},
\code{\link{sf_functional_forms}()},
\code{\link{sf_model_specifications}()},
\code{\link{sf_workhorse}()},
\code{\link{sfaR_summary}()}
}
\concept{frontier analysis}
